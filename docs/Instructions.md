# 説明書

![](./imgs/ringo-viewer.png)


## 画面の構成


### ① ライナー

ステップが読み込まれている最中に表示されます．
これが表示されている間は，ステップの読み込み中であることを表します．
表示がない場合は，ステップの読み込みはおこなわれていません．

### ② ヘッダー

左から順に

-   step：現在のステップ数を表示
-   score：現在のスコアを表示
-   remaining processes：残りの読み込みステップ数を表示

となっています．

下部の緑色のバーは，スコアを表すメーターです．
スコアの減少に応じて，右から左へとメーターが減少します．

### ③ ビューワー

シミュレーションを 2 次元的に表したものを表示しています．

要素の説明

| 要素の表現              | 名称       |
| ----------------------- | ---------- |
| ![](./imgs/ROAD.png)    | 道路       |
| ![](./imgs/BLOCK.png)   | がれき     |
| ![](./imgs/CIV.png)     | 市民       |
| ![](./imgs/FIRE.png)    | 消防隊     |
| ![](./imgs/AMB.png)     | 救急隊     |
| ![](./imgs/POL.png)     | 土木隊     |
| ![](./imgs/BUIL.png)    | 建物       |
| ![](./imgs/B_HINAN.png) | 避難所     |
| ![](./imgs/B_FIRE.png)  | 消防司令部 |
| ![](./imgs/B_AM.png)    | 救急司令部 |
| ![](./imgs/B_POL.png)   | 土木司令部 |

### ④ サイドバー

フィルタリングの際に使用する項目を表示しています．
また ID によってエンティティを検索することができます

### ⑤ アテンション

選択したエンティティの詳細な情報を表示しています．

### ⑥ シークバー

シミュレーションの経過ステップ数と表すバーです．
上部のボタンは，ステップ数を移動するためのものです．

---

## 機能と操作説明


### ③ ビューワー

#### ズームや視点移動

ズームや移動などをおこなうことができます．操作方法は以下の通りです．

| 機能               | トラックパッドでの操作                                      | マウスでの操作                                                       |
| ------------------ | ----------------------------------------------------------- | -------------------------------------------------------------------- |
| 拡大・縮小         | 2 本指を縦方向に動かす                                      | ホイールを使用                                                       |
| 上下左右に移動     | 1 本指でホールドし任意の方向へ移動する                      | マウスの左ボタンをホールドし任意の方向へ移動する                     |
| 視点に角度をつける | shift を押しながら 1 本指でホールドし<br>任意の方向へ傾ける | shift を押しながらマウスの左ボタンをホールドし<br>任意の方向へ傾ける |

#### 詳細表示

情報を知りたいエンティティをホバーすることで，そのエンティティに関するツールチップを表示することができます．
さらに詳細な情報を知りたい際はエンティティをクリックすることで，右側（⑤ アテンション）にそのエンティティの詳細な情報が表示されます．

### ④ サイドバー

ここでは，タブを切り替えることができます．以下は，各タブの説明です．

-   WORLD：シミュレーションの実世界の情報における構成要素が表示されています
-   PERCEPTION：エージェントの知覚情報と，通信で得た情報における構成要素が表示されています
-   ID-SEARCH：任意の ID を入力することで，それと一致する ID を持つエンティティを検索することができます

<!-- 各項目の説明 -->

### ⑤ アテンション

ビューワー上でクリックしたエンティティがエージェントであった場合，左上に「VIEW PERCEPTION」ボタンが表示されます．このボタンを押すことで，そのエージェントの知覚情報と通信により得た情報が，ビューワー上に表示されます．

「VIEW PERCEPTION」ボタンを押した後，WORLD タブ（④ サイドバー）内の項目である実世界が表示されている項目がすべて非表示になり，同時に PERCEPTION タブ（④ サイドバー）に知覚情報に関する項目が追加されます．
「VIEW PERCEPTION」ボタンによって表示された情報は，PERCEPTION タブ（④ サイドバー）より個別にレイヤーを表示非表示を切り替えることができます．

「VIEW PERCEPTION」ボタンによって表示された情報を非表示にするには，下部（⑥ シークバー）に追加された右端の「delete perception view」ボタンを押します．
そうすると，「VIEW PERCEPTION」ボタンによって表示された情報が非表示になり，シミュレーションの実世界における構成要素が表示されます．

<!-- 各項目の説明 -->

### ⑥ シークバー

下部に表示されている青色のバーをドラッグすることで，任意のステップ数まで進めることができます．
また，上部のボタンによってステップ数を進めることもできます．以下は，ボタンの説明です．
| ボタンの表現 | 名称 | 機能 |
| ----------------------- | ---------- | ---------- |
| ![](./imgs/StartB.png) | go to initial step | 最初のステップまで戻ります |
| ![](./imgs/BeforeTenB.png) | go to prev 10 step | 10 ステップだけ戻ります |
| ![](./imgs/BeforeOneB.png) | go to prev step | 1 ステップだけ戻ります |
| ![](./imgs/AfterOneB.png) | go to next step | 1 ステップだけ進みます |
| ![](./imgs/AfterTenB.png) | go to next 10 step | 10 ステップだけ進みます |
| ![](./imgs/EndB.png) | go to last step | 最後のステップまで進みます |

「VIEW PERCEPTION」ボタン（⑤ アテンション内）を押した際に，ボタンがひとつ追加されます．
これを押すと，「VIEW PERCEPTION」ボタンによって表示されていた情報が，非表示になります．

| ボタンの表現         | 名称                   | 機能                                                                  |
| -------------------- | ---------------------- | --------------------------------------------------------------------- |
| ![](./imgs/PerB.png) | delete perception view | 「VIEW PERCEPTION」ボタンによって表示されていた情報が非表示になります |


---

## 仕様詳細

下記では，RRS の仕様を少しだけ紹介しつつ，本ビューワーでの描画方法等についてレイヤーごとに詳細に述べます

### ROAD & BUILDINGS & REFUGE & HYDRANT & GAS_STATION & FIRE_STATION & AMBULANCE_CENTRE & POLICE_OFFICE

道路と建物はプロパティに EDGES という項目があり，これはエッジ（線）の開始位置と終了位置がリストとして格納されています．
これらを1つ1つ結びつけることによって，建物と道路の描画をおこなっています．

### BLOCKADE

瓦礫はプロパティに APEXES  という項目があり，これは apexes（頂点）の x と y が交互にリストとして格納されています．
これらを x と y で1つの頂点として，それらをつなげて描画をおこなっています．

### CIVILIAN & FIRE_BRIGADE & AMBULANCE_TEAM & POLICE_FORCE

人間はプロパティに X と Y があり，これはエンティティのマップ上での重心（位置）を指すものです．
これらをマップ上に x と y で描画させています．

### POSITION_HISTORY

エージェントが移動した際に，POSITION_HISTORY というプロパティが格納されています．
これは，エージェントが移動した x と y 座標が交互に格納されているリストです．
これらを x と y で1つの頂点として線でつなげて，移動した軌跡を赤色で表現しています．
![](./imgs/position-history.png)

### COMMAND_PATH

エージェントが移動する際に，AK_MOVE というコマンドが発行されます． このコマンド内には，そのエージェントが移動する予定である道路や建物のエンティティの ID が順番にリストとして格納されます． COMMAND_PATHレイヤーでは，ここに格納されている道路や建物のエンティティの重心である X と Y のプロパティを頂点として，順番に青色の線として描画しています．

注意点として，この線はエンティティが移動する経路を示しているものではなく，移動に対して通過する建物や道路を示しているということです． よって，ここで示されている線は通過する建物の重心を結んだ線です． そのため，青色の線が道路や建物からはみ出して描画される場合もあります． また，この道路や建物のエンティティID が格納されているリストの最初の ID はそのエンティティが移動を開始した場所の道路や建物のエンティティ ID も含まれています． そのため，移動開始時の道路や建物も線に含まれています．

 そして，描画される線はエンティティの重心を結んだ線であり，これはエンティティの現在位置と重ならないため，どの線がどのエンティティのパスかわかり辛いものになります． その解決策として，移動のパスの最初の点とエージェントの現在位置を線で結んでいます． そのため，表示される通過予定のパスには，まるで一度もどっているかのような描画がされる場合があります．

![](./imgs/move-path.png)

### COMMAND_CLEAR & COMMAND_CLEAR_AREA

土木隊が瓦礫を撤去する際，または撤去した際に，AK_CLEAR または AK_CLEAR_AREA というコマンドが発行されます．

AK_CLEAR には，瓦礫のエンティティ ID が格納されています．
AK_CLEAR が発行された場合は，その瓦礫の啓開が終わりすでにそのステップにはなくなっていることを示しています．
COMMAND_CLEAR レイヤーは，1 ステップ前にはあって現ステップにはない瓦礫を，青色で描画しています．

![](./imgs/ak-clear.png)

AK_CLEAR_AREA は瓦礫の啓開をおこなう予定の地点までの x と y 座標が含まれています．
COMMAND_CLEAR_AREA レイヤーは，その土木隊の位置から，その土木隊が啓開をおこなう予定の地点までの x と y 座標までを青色の線で結んで描画しています．<br>
ただし，1ステップで啓開できる距離は限られているため，示された地点まで啓開するのに数ステップかかることがあります．その場合は，画像のようにがれき上に青色の線が描画され，啓開途中であることが読み取れます．

![](./imgs/ak-clear-area.png)

### visible*
visibleで始まるレイヤーは全て，「view perception」にて選択されたエンティティが実際に見た情報が描画されます
その知覚情報を見ているエンティティは水色のマークで表示されます．
また，ここでは情報は現在エージェントが見た情報だけではなく，過去に最後に認知したエンティティの情報も全て描画されます．
そのため，このデータは過去のデータも描画され，古い情報と新しい情報が含まれます．
また，ここで描画される内容は，実際にそのエージェントが行動をする前に見た情報が描画されます．
そのため，この知覚情報を見てこのエージェントは行動をしたと言え，またこの知覚情報は1ステップ古い情報であるとも言えます．
また，全エージェントは0ステップ時にマップの情報だけ渡されるため，知覚していない建物や道路などは，素の状態を認知しており，素の状態を描画しています．

![](./imgs/perception-visible.png)


### communication*
communicationから始まるレイヤーには，知覚情報を見ているエージェントが受信した通信が描画されています．

#### ROAD
ROADは，道路が通行不可能かを示すレイヤーです．
画像のように色が濃く変化している道路は，通信により通行不可能という情報を得た部分になっています．

ここで受診するデータは，どこの道路が通行可能か不可能かという情報だけです．
そのため，瓦礫がどのような形で，瓦礫の啓開に要するコストなどはデータは含まれていません．
結果として，道路全体に深い灰色の色を使って描画するという方法をとっています．


![](./imgs/communicatioin-road.png)

#### AMBULANCE_TEAM & CIVILIAN & FIRE_BRIGADE & POLICE_FORCE
AMBULANCE_TEAM，CIVILIAN，FIRE_BRIGADE，POLICE_FORCEは，そのエージェントがどこにいるのかを示すレイヤーです．

ここには，知覚情報を見ているエージェント自身が発信して，自身の発信したものも含めた通信内容も含まれます．
通信の送信と受信にはステップ数が数回必要であり，過去の自分の情報を受信し，描画されるため，水色のエージェントが2体表示される場合があります．


![](./imgs/communication-human.png)

#### CENTRALIZED
CENTRALIZEDは司令塔によって命令された対象の建物を示すレイヤーです．
司令塔は通信を通じて，災害救助エージェントに対して救助活動の必要性がある場所を知らせています．
注意点として，この表現における水色は透過されているので，該当する建物の倒壊度によって色が変化します．

![](./imgs/communication-cen.png)

#### Target
Targetはエージェントが行動する先をアークで示すレイヤーです．
アークの色は，開始点については各エージェントと同じ色または行動対象の色で表現され，到着点に近づくにつれて黄色に変化していきます．
また，アークが示す到着点はエンティティの重心であるため，実際にエージェントが到着する地点と多少のずれが生じます．

![](./imgs/communication-target.png)


<!-- レイヤーの重ね順について書く(viewer.tsxを見て記述「だからいい感じに表示非表示してくださいねーっていう」) -->


---

## レイヤーの重ね順について
注意点として，上記で説明したレイヤーは重ねる順番が指定されています．
そのため，自分が見たい情報が他のレイヤーの下に表示されてしまい，うまく確認できない場合があります．
下記に，レイヤーの重ね順を記述しておきますので，この順番を意識して自分の見たいレイヤーが上に来るようにフィルタリングをおこなってください．

8から順に重ねられているため，1が一番上にあるレイヤーです．
④内のタブ名(フィルタリングの項目名)のように表示しています．

1. テキスト

WORLD(HELP_MESSAGE)

2. アーク

WORLD(COMMUNICATION_TARGET)，PERCEPTION(communicationTarget)

3. 軌跡

WORLD(POSITION_HISTORY)，WORLD(PATH)，WORLD(CLEAR_AREA)

4. communicationの人間たち

PERCEPTION(communicationAMBULANCE_TEAM)，
PERCEPTION(communicationCIVILIAN)，
PERCEPTION(communicationFIRE_BRIGADE)，
PERCEPTION(communicationPOLICE_FORCE)

5. visibleの人間たち

PERCEPTION(visibleCIVILIAN)，
PERCEPTION(visibleFIRE_BRIGADE)，
PERCEPTION(visibleAMBULANCE_TEAM)，
PERCEPTION(visiblePOLICE_FORCE)

6. 実世界の人間たち

WORLD(CIVILIAN)，
WORLD(FIRE_BRIGADE)，
WORLD(AMBULANCE_TEAM)，
WORLD(POLICE_FORCE)

7. communicationのcentralized

PERCEPTION(communicationCENTRALIZED)

8. visibleの建物たち

PERCEPTION(visibleROAD)，
PERCEPTION(communicationROAD)，
PERCEPTION(visibleBUILDING)，
PERCEPTION(visiblePOLICE_OFFICE)，
PERCEPTION(visibleREFUGE)，
PERCEPTION(visibleHYDRANT)，
PERCEPTION(visibleGAS_STATION)，
PERCEPTION(visibleFIRE_STATION)，
PERCEPTION(visibleAMBULANCE_CENTRE)，
PERCEPTION(visibleBLOCKADE)

8. commandの建物たち

WORLD(CLEAR)

9. 実世界の建物たち

WORLD(ROAD),
WORLD(BUILDING),
WORLD(POLICE_OFFICE),
WORLD(REFUGE),
WORLD(HYDRANT),
WORLD(GAS_STATION),
WORLD(FIRE_STATION),
WORLD(AMBULANCE_CENTRE),
WORLD(BLOCKADE)